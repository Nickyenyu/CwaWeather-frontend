<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2B3A67">
    
    <title>ğŸ¦Šå°å®‡çš„å‹•ç‰©å¤©æ°£ğŸ°</title>
    
    <link rel="icon" type="image/png" href="./icon-v2.png">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pulltorefreshjs/0.1.22/index.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --zp-blue-dark: #1A2A40; 
            --zp-orange: #FF8C42; 
            --zp-purple: #6C5B7B;
            --zp-neon-blue: #00d2ff;
            --zp-nick: #E67E22;
            --zp-judy: #9B59B6; 
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            min-height: 100vh; color: var(--zp-blue-dark); overflow-x: hidden; padding-bottom: 80px;
            background-color: #2B3A67;
            background-attachment: fixed; 
            transition: background 1.5s ease;
            padding-top: env(safe-area-inset-top);
        }

        /* === ğŸ¨ èƒŒæ™¯ä¸»é¡Œä¿®æ­£ === */
        body.morning { 
            background-image: 
                radial-gradient(circle, rgba(255,255,255,0.4) 2px, transparent 2.5px),
                linear-gradient(120deg, #a1ffce 0%, #faffd1 100%);
            background-size: 30px 30px, 100% 100%;
        }
        body.noon { 
            background-image: 
                repeating-linear-gradient(45deg, rgba(255,255,255,0.2) 0, rgba(255,255,255,0.2) 2px, transparent 0, transparent 40px),
                linear-gradient(135deg, #fce38a 0%, #f38181 100%);
            background-size: auto, 100% 100%;
        }
        body.afternoon { 
            background-image: 
                linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.1) 100%),
                linear-gradient(135deg, #43cea2 0%, #185a9d 100%);
            background-size: 100% 100%, 100% 100%;
        }
        body.night { 
            background-image: 
                radial-gradient(rgba(255,255,255,0.5) 1px, transparent 0),
                linear-gradient(to bottom, #2980b9 0%, #2c3e50 100%);
            background-size: 50px 50px, 100% 100%;
        }

        /* === ğŸ™ï¸ åŸå¸‚å¤©éš›ç·š === */
        .city-skyline {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 35vh;
            z-index: -1; pointer-events: none; opacity: 0.85;
            background-repeat: repeat-x; background-position: bottom; background-size: auto 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 284'%3E%3Cpath fill='%231a2639' d='M0,284 L0,150 L30,150 L30,100 L60,100 L60,180 L80,180 L80,60 L120,60 L120,200 L150,200 L150,80 L200,80 L200,220 L230,220 L230,40 L280,40 L280,190 L310,190 L310,10 L360,10 L360,160 L390,160 L390,70 L440,70 L440,210 L470,210 L470,30 L520,30 L520,180 L550,180 L550,90 L600,90 L600,230 L630,230 L630,50 L680,50 L680,170 L710,170 L710,20 L760,20 L760,190 L790,190 L790,110 L840,110 L840,240 L870,240 L870,0 L920,0 L920,160 L950,160 L950,80 L1000,80 L1000,284 Z'/%3E%3C/svg%3E");
            mask-image: linear-gradient(to top, black 50%, transparent 100%);
            -webkit-mask-image: linear-gradient(to top, black 50%, transparent 100%);
        }

        .rain-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; display: none;
        }
        .rain-drop {
            position: absolute; top: -10px; width: 2px; height: 15px;
            background: rgba(255, 255, 255, 0.6); animation: rain linear infinite;
        }
        @keyframes rain {
            0% { transform: translateY(-10px); opacity: 0; }
            90% { opacity: 1; } 100% { transform: translateY(100vh); opacity: 0; }
        }

        /* é ‚éƒ¨ç‹€æ…‹åˆ— */
        .status-bar {
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;
            background: rgba(26, 42, 64, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.15);
            top: env(safe-area-inset-top); color: white; box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }

        .location-wrapper {
            background: rgba(255,255,255,0.15); border: 1px solid var(--zp-neon-blue);
            border-radius: 8px; padding: 5px 10px; display: flex; align-items: center;
        }
        .location-select {
            appearance: none; background: transparent; border: none; color: var(--zp-neon-blue);
            font-size: 1rem; font-weight: 700; width: 100%; font-family: 'Zen Maru Gothic', sans-serif;
        }
        .gps-btn {
            background: rgba(0, 210, 255, 0.2); color: var(--zp-neon-blue);
            border: 1px solid var(--zp-neon-blue); border-radius: 4px; padding: 5px 10px; margin-left: 8px;
            font-weight: bold; cursor: pointer; backdrop-filter: blur(5px);
        }

        .zpd-badge {
            font-family: 'Share Tech Mono', monospace; text-align: right;
            border-right: 2px solid var(--zp-neon-blue); padding-right: 10px;
        }
        .zpd-label { font-size: 0.6rem; color: #ccc; letter-spacing: 2px; }
        .zpd-time { font-size: 1rem; color: white; text-shadow: 0 0 8px var(--zp-neon-blue); font-weight: 700; }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; position: relative; z-index: 1;}
        
        /* === Hero Card === */
        .hero-card {
            background: var(--glass-bg); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-radius: 24px; padding: 20px 15px; box-shadow: var(--glass-shadow);
            margin-bottom: 25px; position: relative; overflow: visible; 
            border: 1px solid var(--glass-border);
            /* ä¿®æ­£ï¼šå¢åŠ åº•éƒ¨ç©ºé–“ï¼Œé¿å…å¡ç‰‡å…§å®¹è²¼åº• */
            padding-bottom: 25px;
        }
        
        /* ä¿®æ­£ï¼šå°‡ ZPD CASE FILE ç§»åˆ°å¡ç‰‡å·¦ä¸Šè§’ï¼Œåƒæª”æ¡ˆç·¨è™Ÿä¸€æ¨£ */
        .hero-card::before {
            content: "ZPD CASE FILE #9527"; 
            position: absolute; top: -12px; left: 20px;
            background: var(--zp-blue-dark); color: var(--zp-neon-blue);
            font-family: 'Share Tech Mono', monospace; 
            font-size: 0.8rem; font-weight: bold; 
            padding: 4px 12px; border-radius: 12px;
            border: 1px solid var(--zp-neon-blue);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            pointer-events: none; letter-spacing: 1px;
            z-index: 15;
        }
        /* ç§»é™¤åŸæœ¬å³ä¸‹è§’çš„æµ®æ°´å°ï¼Œé¿å…é‡ç–Š */
        .hero-card::after { content: none; }

        .partners-stage {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 15px; position: relative; height: 140px;
            /* å¢åŠ é ‚éƒ¨ margin è®“å‡ºä½ç½®çµ¦æ–°çš„æ¨™ç±¤ */
            margin-top: 10px;
        }
        .character {
            width: 90px; height: 90px; /* æ‰‹æ©Ÿç‰ˆç¨å¾®ç¸®å°ä¸€é»é ­åƒ */
            border-radius: 50%;
            background-color: rgba(255,255,255,0.6); border: 3px solid white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            position: relative; display: flex; justify-content: center; align-items: center;
            font-size: 4rem; overflow: hidden; background-size: cover; background-position: center;
            backdrop-filter: blur(5px);
        }
        .char-judy { border-color: var(--zp-judy); }
        .char-nick { border-color: var(--zp-nick); }

        /* === ä¿®æ­£ï¼šå°è©±æ°£æ³¡ä¸é‡ç–Š === */
        .dialogue-bubble {
            position: absolute; top: -25px; /* å¾€ä¸Šæä¸€é» */
            width: 110px; /* é™åˆ¶å¯¬åº¦ï¼Œé¿å…å¤ªå¯¬ */
            background: rgba(255, 255, 255, 0.95); padding: 6px 10px; border-radius: 16px;
            font-size: 0.8rem; font-weight: bold; color: var(--zp-blue-dark);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid white;
            opacity: 0; transform: translateY(10px);
            animation: popIn 0.5s forwards 0.5s; z-index: 10;
            white-space: normal; /* å…è¨±æ›è¡Œï¼ */
            line-height: 1.3;
            text-align: center; /* æ–‡å­—ç½®ä¸­ */
        }
        .bubble-left { left: -10px; border-bottom-left-radius: 0; }
        .bubble-right { right: -10px; border-bottom-right-radius: 0; }
        @keyframes popIn { to { opacity: 1; transform: translateY(0); } }

        /* å¤©æ°£è³‡è¨Šå°é½Š */
        .weather-center {
            position: absolute; left: 50%; bottom: 0;
            transform: translateX(-50%); z-index: 5;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            width: 120px; /* çµ¦äºˆå›ºå®šå¯¬åº¦ï¼Œç¢ºä¿å±…ä¸­ */
        }
        .main-icon { 
            font-size: 5rem; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.15)); 
            line-height: 1; margin-bottom: -5px; 
        }
        .main-temp { 
            font-size: 3.2rem; font-weight: 900; color: var(--zp-blue-dark); 
            line-height: 1; text-shadow: 0 0 20px rgba(255,255,255,0.8);
            text-align: center;
        }

        .advice-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px;
            padding-top: 15px; border-top: 2px dashed rgba(43, 58, 103, 0.2);
        }
        .advice-item {
            background: rgba(255, 255, 255, 0.5); padding: 12px 8px; border-radius: 16px;
            text-align: center; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.4);
        }
        .advice-icon { font-size: 1.8rem; margin-bottom: 4px; }
        .advice-text { font-size: 1rem; font-weight: 900; color: var(--zp-blue-dark); line-height: 1.2; }
        .advice-sub { font-size: 0.75rem; color: #555; margin-top: 4px; font-weight: bold; }

        .section-header {
            display: flex; align-items: center; margin-bottom: 12px;
            background: rgba(0, 0, 0, 0.25); padding: 6px 16px; border-radius: 20px;
            backdrop-filter: blur(10px); display: inline-flex; border: 1px solid rgba(255,255,255,0.15);
        }
        .section-title { font-size: 1.1rem; color: white; font-weight: 900; margin-left: 6px; text-shadow: 0 2px 4px rgba(0,0,0,0.4); }

        .forecast-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-bottom: 20px;
        }
        .mini-card {
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: 18px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative;
            transition: transform 0.2s; border: 1px solid rgba(255, 255, 255, 0.6);
        }
        .mini-card:active { transform: scale(0.98); }
        .card-top {
            background: rgba(26, 42, 64, 0.85); color: white; padding: 6px;
            font-size: 0.85rem; font-weight: bold; font-family: 'Share Tech Mono';
        }
        .card-content { padding: 12px; text-align: center; }
        .card-icon { font-size: 2.8rem; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.1)); margin-bottom: 5px;}
        .card-temp { font-weight: 900; font-size: 1.3rem; color: var(--zp-blue-dark); }
        
        .rain-bar-bg {
            width: 100%; height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px;
            margin-top: 8px; overflow: hidden; position: relative;
        }
        .rain-bar-fill {
            height: 100%; background: var(--zp-neon-blue); border-radius: 4px; width: 0%;
            transition: width 0.5s ease; box-shadow: 0 0 8px var(--zp-neon-blue);
        }

        .loading-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--zp-blue-dark);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999;
        }
        .snapshot-btn {
            position: absolute; top: 12px; right: 12px; background:rgba(255,255,255,0.9); border:none;
            width:36px; height:36px; border-radius:50%; font-size:1.3rem; cursor:pointer; z-index:20;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15); transition: transform 0.2s;
        }
        .snapshot-btn:active { transform: scale(0.9); }
    </style>
</head>
<body>
    <div id="loading" class="loading-screen">
        <div style="font-size: 5rem;">ğŸ°ğŸš”ğŸ¦Š</div>
        <p style="color: white; margin-top: 10px; font-weight: bold; letter-spacing: 1px;">é€£ç·šè‡³ ZPD è³‡æ–™åº«...</p>
    </div>

    <div class="city-skyline"></div>
    <div id="rainContainer" class="rain-container"></div>

    <div class="status-bar">
        <div style="display: flex; align-items: center;">
            <div class="location-wrapper">
                <select id="citySelect" class="location-select"></select>
            </div>
            <button class="gps-btn" onclick="locateUser()">ğŸ›°ï¸</button>
        </div>
        <div class="zpd-badge">
            <div class="zpd-label">ZPD TERMINAL</div>
            <div class="zpd-time" id="zpdTime">--/-- --:--:--</div>
        </div>
    </div>
    
    <div class="container" id="mainContent" style="display:none;">
        
        <div id="heroCard" class="hero-card">
            <button class="snapshot-btn" onclick="shareSnapshot()">ğŸ“·</button>
            <div class="partners-stage">
                <div style="position: relative;">
                    <div id="judyTalk" class="dialogue-bubble bubble-left">...</div>
                    <div class="character char-judy">ğŸ°</div>
                </div>
                <div class="weather-center">
                    <div id="mainIcon" class="main-icon">â˜€ï¸</div>
                    <div id="mainTemp" class="main-temp">--Â°</div>
                </div>
                <div style="position: relative;">
                    <div id="nickTalk" class="dialogue-bubble bubble-right">...</div>
                    <div class="character char-nick">ğŸ¦Š</div>
                </div>
            </div>
            
            <div id="adviceSection" class="advice-grid"></div>
        </div>
        
        <div class="section-header">
            <span>ğŸ“‚</span><span class="section-title">ç¨å¾Œé å ±</span>
        </div>
        <div class="forecast-grid" id="futureForecasts"></div>
    </div>

    <script>
        const API_BASE_URL = "https://weat-taipei.zeabur.app";
        
        const CITIES = [
            { name: "å°åŒ—å¸‚", value: "taipei", lat: 25.032, lon: 121.565 },
            { name: "æ–°åŒ—å¸‚", value: "new_taipei", lat: 25.012, lon: 121.465 },
            { name: "åŸºéš†å¸‚", value: "keelung", lat: 25.127, lon: 121.739 },
            { name: "æ¡ƒåœ’å¸‚", value: "taoyuan", lat: 24.993, lon: 121.300 },
            { name: "æ–°ç«¹å¸‚", value: "hsinchu_city", lat: 24.813, lon: 120.967 },
            { name: "æ–°ç«¹ç¸£", value: "hsinchu_county", lat: 24.838, lon: 121.017 },
            { name: "å®œè˜­ç¸£", value: "yilan", lat: 24.757, lon: 121.752 },
            { name: "è‹—æ —ç¸£", value: "miaoli", lat: 24.560, lon: 120.821 },
            { name: "å°ä¸­å¸‚", value: "taichung", lat: 24.147, lon: 120.673 },
            { name: "å½°åŒ–ç¸£", value: "changhua", lat: 24.051, lon: 120.516 },
            { name: "å—æŠ•ç¸£", value: "nantou", lat: 23.960, lon: 120.697 },
            { name: "é›²æ—ç¸£", value: "yunlin", lat: 23.709, lon: 120.538 },
            { name: "å˜‰ç¾©å¸‚", value: "chiayi_city", lat: 23.480, lon: 120.449 },
            { name: "å˜‰ç¾©ç¸£", value: "chiayi_county", lat: 23.451, lon: 120.292 },
            { name: "å°å—å¸‚", value: "tainan", lat: 22.999, lon: 120.226 },
            { name: "é«˜é›„å¸‚", value: "kaohsiung", lat: 22.627, lon: 120.301 },
            { name: "å±æ±ç¸£", value: "pingtung", lat: 22.674, lon: 120.488 },
            { name: "èŠ±è“®ç¸£", value: "hualien", lat: 23.987, lon: 121.601 },
            { name: "å°æ±ç¸£", value: "taitung", lat: 22.758, lon: 121.144 },
            { name: "æ¾æ¹–ç¸£", value: "penghu", lat: 23.571, lon: 119.566 },
            { name: "é‡‘é–€ç¸£", value: "kinmen", lat: 24.440, lon: 118.322 },
            { name: "é€£æ±Ÿç¸£", value: "lienchiang", lat: 26.157, lon: 119.951 }
        ];

        function getDialogue(weather, temp, rain) {
            const t = parseInt(temp);
            const r = parseInt(rain.replace('%',''));
            let judy = "ä»Šå¤©é©åˆå·¡é‚ï¼";
            let nick = "é©åˆå»è²·çˆªå­å†°æ£ã€‚";

            if (weather.includes("é›¨") || r > 50) {
                judy = "è¨˜å¾—å¸¶å‚˜ï¼Œå°å¿ƒè·¯æ»‘ï¼"; nick = "æˆ‘ä¸å–œæ­¡æ¿•ç­”ç­”çš„...";
            } else if (t >= 28) {
                judy = "å¥½ç†±ï¼æ³¨æ„è£œå……æ°´åˆ†ã€‚"; nick = "èª°æŠŠç©ºèª¿é—œæ‰äº†ï¼Ÿ";
            } else if (t >= 23 && t < 28) {
                judy = "å¤©æ°£çœŸèˆ’æœï¼"; nick = "é©åˆåˆç¡çš„æº«åº¦ã€‚";
            } else if (t >= 18 && t < 23) {
                judy = "æœ‰é»æ¶¼æ„ï¼Œç©¿ä»¶èƒŒå¿ƒå§ã€‚"; nick = "é€™æº«åº¦å‰›å¥½ï¼Œä¸ç”¨é–‹å†·æ°£ã€‚";
            } else if (t < 18) {
                judy = "å¥½å†·ï¼å¤§å®¶æ³¨æ„ä¿æš–ã€‚"; nick = "æˆ‘è¦èº²å›è¢«çª©äº†...";
            } 
            
            return { judy, nick };
        }

        function getAdvice(rainProb, maxTemp) {
            let rainIcon = "ğŸŒ‚"; let rainText = "å‚˜ï¼Ÿä¸ç”¨äº†å•¦";
            const rainVal = parseInt(rainProb) || 0;
            if (rainVal > 30) { rainIcon = "â˜‚ï¸"; rainText = "è¨˜å¾—å¸¶å‚˜ï¼"; }

            let clothIcon = "ğŸ‘•"; let clothText = "ç©¿å¾—èˆ’æœï½";
            const tempVal = parseInt(maxTemp) || 20;
            if (tempVal >= 28) { clothIcon = "ğŸ½"; clothText = "ç©¿çŸ­è¢–å§"; }
            else if (tempVal >= 22 && tempVal < 28) { clothIcon = "ğŸ‘•"; clothText = "èˆ’é©ç©¿æ­"; }
            else if (tempVal < 22) { clothIcon = "ğŸ§¥"; clothText = "æœ‰é»æ¶¼ç©¿å¤–å¥—"; }

            return { rainIcon, rainText, clothIcon, clothText };
        }

        PullToRefresh.init({
            mainElement: 'body',
            onRefresh: function() { return fetchWeather(document.getElementById('citySelect').value); },
            distThreshold: 60, iconArrow: 'â¬‡ï¸', iconRefreshing: 'ğŸš”',
            instructionsPullToRefresh: 'ä¸‹æ‹‰é€£ç·š ZPD', instructionsReleaseToRefresh: 'æ”¾é–‹æ›´æ–°',
        });

        function updateZpdTime() {
            const now = new Date();
            const pad = (n) => n.toString().padStart(2,'0');
            const mon = pad(now.getMonth() + 1);
            const day = pad(now.getDate());
            const hh = pad(now.getHours());
            const mm = pad(now.getMinutes());
            const ss = pad(now.getSeconds()); // å¢åŠ ç§’æ•¸
            document.getElementById('zpdTime').textContent = `${mon}/${day} ${hh}:${mm}:${ss}`;
        }
        setInterval(updateZpdTime, 1000); updateZpdTime();

        function locateUser() {
            if (!navigator.geolocation) { alert("ä¸æ”¯æ´å®šä½"); return; }
            navigator.geolocation.getCurrentPosition((pos) => {
                let minDesc=Infinity, nearest=null;
                CITIES.forEach(c => {
                    const d = Math.sqrt(Math.pow(c.lat - pos.coords.latitude, 2) + Math.pow(c.lon - pos.coords.longitude, 2));
                    if(d < minDesc) { minDesc = d; nearest = c; }
                });
                if(nearest) {
                    document.getElementById('citySelect').value = nearest.value;
                    fetchWeather(nearest.value);
                }
            });
        }

        function shareSnapshot() {
            const card = document.querySelector('.hero-card');
            const btn = document.querySelector('.snapshot-btn');
            btn.style.display = 'none';
            html2canvas(card, { backgroundColor: null, scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `ZPD-Weather-${Date.now()}.png`;
                link.href = canvas.toDataURL(); link.click();
                btn.style.display = 'flex';
            }).catch(() => { btn.style.display = 'flex'; });
        }

        function updateBackground(weatherDesc) {
            const h = new Date().getHours();
            const b = document.body;
            b.className = '';
            
            const pc = document.getElementById('rainContainer'); // å¾©ç”¨ rainContainer ç•¶ä½œç²’å­å±¤
            pc.innerHTML = ''; 

            if (weatherDesc && (weatherDesc.includes('é›¨') || weatherDesc.includes('é›·'))) {
                b.classList.add('afternoon');
                createRain(pc);
            } else {
                if(h>=6 && h<11) b.classList.add('morning');
                else if(h>=11 && h<16) b.classList.add('noon');
                else if(h>=16 && h<19) b.classList.add('afternoon');
                else {
                    b.classList.add('night');
                }
            }
        }

        function createRain(container) {
            for(let i=0; i<50; i++) {
                const d = document.createElement('div'); d.classList.add('rain-drop');
                d.style.left = Math.random()*100+'vw';
                d.style.animationDuration = (Math.random()*1+0.5)+'s';
                d.style.animationDelay = Math.random()*2+'s';
                container.appendChild(d);
            }
        }

        function getWeatherIcon(w) {
            if(!w) return "ğŸŒ¤ï¸";
            if(w.includes("æ™´")) return "â˜€ï¸";
            if(w.includes("å¤šé›²")) return "ğŸŒ¥ï¸";
            if(w.includes("é™°")) return "â˜ï¸";
            if(w.includes("é›¨")) return "ğŸŒ§ï¸";
            if(w.includes("é›·")) return "â›ˆï¸";
            return "ğŸŒ¤ï¸";
        }

        function renderWeather(data) {
            const current = data.forecasts[0];
            const others = data.forecasts.slice(1);
            const avgTemp = Math.round((parseInt(current.maxTemp) + parseInt(current.minTemp)) / 2);
            
            updateBackground(current.weather);

            const dialogue = getDialogue(current.weather, avgTemp, current.rain);
            document.getElementById('judyTalk').textContent = dialogue.judy;
            document.getElementById('nickTalk').textContent = dialogue.nick;

            document.getElementById('mainIcon').textContent = getWeatherIcon(current.weather);
            document.getElementById('mainTemp').textContent = `${avgTemp}Â°`;
            
            const advice = getAdvice(current.rain, current.maxTemp);
            document.getElementById('adviceSection').innerHTML = `
                <div class="advice-item">
                    <div class="advice-icon">${advice.rainIcon}</div>
                    <div class="advice-text">${advice.rainText}</div>
                    <div class="advice-sub">é™é›¨ç‡ ${current.rain}</div>
                </div>
                <div class="advice-item">
                    <div class="advice-icon">${advice.clothIcon}</div>
                    <div class="advice-text">${advice.clothText}</div>
                    <div class="advice-sub">æ°£æº« ${current.minTemp}-${current.maxTemp}Â°C</div>
                </div>
            `;

            const container = document.getElementById('futureForecasts');
            container.innerHTML = '';
            others.forEach(f => {
                let p = new Date(f.startTime).getHours() < 12 ? "æ—©" : "æ™š";
                if(new Date(f.startTime).getDate() !== new Date().getDate()) p = "æ˜å¤©" + p;
                
                const rainVal = parseInt(f.rain.replace('%','')) || 0;

                container.innerHTML += `
                    <div class="mini-card">
                        <div class="card-top">ZPD-LOG: ${p}</div>
                        <div class="card-content">
                            <div class="card-icon">${getWeatherIcon(f.weather)}</div>
                            <div class="card-temp">${f.minTemp}-${f.maxTemp}Â°</div>
                            
                            <div class="rain-bar-bg">
                                <div class="rain-bar-fill" style="width: ${Math.min(rainVal, 100)}%;"></div>
                            </div>
                            <div style="font-size:0.8rem; color:#666; margin-top:4px; display:flex; justify-content:space-between;">
                                <span>é™é›¨æ©Ÿç‡</span>
                                <span>${f.rain}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        async function fetchWeather(city) {
            document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch(`${API_BASE_URL}/api/weather/${city}`);
                const json = await res.json();
                if (json.success) {
                    renderWeather(json.data);
                    setTimeout(() => {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('mainContent').style.display = 'block';
                    }, 500);
                } else { throw new Error(json.message); }
            } catch (e) { 
                alert("é€£ç·šå¤±æ•—ï¼š" + e.message); 
                document.getElementById('loading').style.display = 'none';
            }
        }

        const select = document.getElementById('citySelect');
        CITIES.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.value; opt.text = c.name;
            select.appendChild(opt);
        });
        select.value = "taipei";
        select.addEventListener('change', (e) => fetchWeather(e.target.value));
        fetchWeather("taipei");
    </script>
</body>
</html>